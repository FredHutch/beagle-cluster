#!/usr/bin/env python3

# Resume or suspend nodes indicated in the argument list.
#
# Slurm will call this program as `resume` or `suspend` with a Slurm hostlist
# as its argument.  This will expand the Slurm hostlist
# (nodename[1-2,4],othername1, etc) and build an instance list from this
# expanded list by searching on the `Name` tag

import sys
import os
import boto3

import logging
logging.basicConfig(
        filename='/var/log/slurm-llnl/slurm-power-control.log',
        level=logging.DEBUG
        )

# Uses NSC hostlist (https://www.nsc.liu.se/~kent/python-hostlist/)
import hostlist

# Link to this script with "resume" or "suspend", vis:
#    resume -> slurm-power-control.py
#    slurm-power-control.py
#
# The name indicates the action and is thus found in argv[0].  We'll use this
# downstream when it's time to actually perform an action (the remaining logic
# of assembling the list of instances is identical in either case)

action = os.path.basename(sys.argv[0])
nodelist_raw = sys.argv[1]
logging.debug("Starting: action {} on nodes {}".format(action, nodelist_raw))

nodelist = hostlist.expand_hostlist(nodelist_raw)

ec2 = boto3.client('ec2', region_name='us-west-2')
logging.debug("EC2 client connection complete")

# build filter list:

instance_filter = [{'Name': 'tag:Name', 'Values': nodelist }]

logging.debug("describing instances with filter {}".format(instance_filter))
response = ec2.describe_instances( Filters = instance_filter )
logging.debug("complete, {} records found".format(len(response['Reservations'])))

# Build list of instances from this response.  The instance id is found in 
# r['Reservations'][N]['Instances'][0]['InstanceId']

# Better way of doing this must exist...

instance_ids = []
for r in response['Reservations']:
    instance_ids.append(r['Instances'][0]['InstanceId'])

logging.debug("acting on instances {}".format(instance_ids))
if action == 'resume':
    logging.debug("Resuming/starting instances")
    response = ec2.start_instances(InstanceIds=instance_ids)
elif action == 'suspend':
    logging.debug("Suspending/stopping instances")
    response = ec2.stop_instances(InstanceIds=instance_ids)
